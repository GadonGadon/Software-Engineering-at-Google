이번 장에서는 거대한 **구글 코드베이스가 기반 인프라의 변경을 유연하게 받아들일 수 있도록 해준 사회적 기법과 기술적 기법**을 이야기함. 실제 이 기법들을 구글이 실제 어디에 어떻게 적용했는지도 공개. 이 원칙을 잘 이해한다면 당신의 회사의 코드베이스가 구글처럼 크지 않더라도 개발 조직을 확장하면서 코드베이스 전반을 유익하게 하는데 무리가 없을 것이다.

### 대규모 변경이란?

구글의 경우 LCS(Large-Scale-Change)는 거의 항상 **자동화 도구**를 이용해 생성. 

LCS 로 인해 변경되는 대체적인 것들

- **코드베이스 전반을 훓는 분석 도구**로 찾은 **공통 안티패턴 청소**
- **폐기 대상 API 호출 대체**
- (컴파일러 업그레이드 등) **저수준 인프라 개선사항 활성화**
- 사용자들을 옛 시스템에서 새로운 시스템으로 **마이그레이션**

LCS를 촉발하는 원인은 다양하다. 더 효율적인 프로그래밍 이디엄을 적용하거나 내부 라이브러리의 인터페이스가 바뀌었을 수 있고 잠재해 있던 문제들을 신버전 컴파일러가 찾아줘서 모두 해결해야 할 수도 있다.

### 누가 대규모 변경을 처리하나?

구글에서는 LSC의 상당 비중을 **인프라팀**들이 수행하고 있고, 이유는 다음과 같다. (누구든 이용가능)

1. 하부 시스템을 구축하고 관리하는 팀으로 필요한 도메인 지식을 갖추고 있음
    1. 인프라를 이용하는 팀들은 마이그레이션을 처리하는 방법을 모를 가능성이 큼
    2. 인프라팀이 갖춘 전문지식을 다른 모든 팀에게 새로 배우도록 시키는 것은 비효율적임
    3. 마이그레이션 도중 문제 발생 시 한 데 모여있어 더 빠르게 복구가능
2. 마이그레이션을 중앙에서 처리하면 개별 팀에 떠넘긴 후 전체를 조율해가며 진행하는 유기적 마이그레이션보다 거의 항상 더 빠르고 저렴함

### 원자적 변경을 가로막는 요인

이상적으로 모든 논리적 변경은 하나의 원자적 단위로 묶어 다른 변경들과 독립적으로 한 번에 테스트하고 리뷰하고 커밋할 수 있어야함. 하지만 리포지터리가 커지고 이용하는 엔지니어가 많아질수록 이상은 점점 멀어짐

1. 기술적 한계  : 버전관리 시스템에서 기능을 수행하는 비용이 변경의 크기만큼 비례해 커짐(파일 수천개 커밋 시 메모리 프로세싱 능력 부족)
2. 병합 충돌 
3. 유령의 묘지 : 너무 오래되고, 둔하고, 복잡해 아무도 손대려 하지않는 시스템, 잘못 손댂다가는 이해할 수 없는 문제가 발생하여 사업적으로 막대한 손실을 입을 수 있어 과거 어느 시점부터 시간이 멈춰버린 것
4. 이질성: 하나의 조직에서 다양한 Version Control Syste와 Corporate Identity시스템을 운영하고 프로젝트별로 도구와 스타일 가이드가 다르면 코드베이스 전체를 아우르는 변경은 진행하기 어려움
5. 테스트 : 변경의 덩치가 커지면 테스트하기 어려움
6. 코드리뷰 : 거대한 커밋을 검토하는 것은 지루하고 번거롭고 오류가 스며들기 쉬움

### 대규모 변경 인프라

구글은 LSC를 가능케 하기 위해 막대한 투자를 함.

1. 정책적 문화 : 수많은 소스 코드를 하나의 리포지터리에 보관하며 모든 엔지니어가 그 안의 코드 대부분을 볼 수 있음
2. 코드베이스 인사이트: 함수 호출 코드 위치 등 코드베이스 영역 간 관계를 보여주는 완벽한 지도 만들기(Kythe이용)
3. 변경 관리 : 마스터 변경을 여러 개의 샤드로 나눈 후 테스트, 메일링, 리뷰, 커밋 단계를 독립적으로 관리 해주는 도구 필요(Rosie 사용: 수많은 변경을 독립적으로 테스트, 리뷰, 서브밋할 수 있는 작은 샤드들로 나눌 수 있음)
4. 테스트 : 구글은 마스터 변경이 문제를 일으키지 않음을 확인하는 것 이외에 개별 샤드를 안전하고 독립적으로 서브밋할 수 있는지까지 검증함
5. 언어 지원 : 타입 별칭과 전달 함수를 지원하는 프로그래밍 언어라면 새로운 시스템으로 마이그레이션하는 중에도 기존 코드가 문제없이 동작하기 어려움 그래서 언어 지원 기능 필요

### 대규모 변경 프로세스

LSC 프로세스는 크게 4단계로 이루어짐 (새로운 시스템을 설계할 때부터 이를 염두해 두어야 함)

1. 권한 부여 : 구글은 LSC작성자에게 변경을 제안하는 이유, 코드베이스 전반에 주는 예상 영향, 리뷰어들이 던질만한 질문과 그에 대한 답변을 간단하게 제안 문서를 작성해달라고 요청함
    1. 작성자는 리팩터링될 API들의 소유자들로부터 도메인 리뷰도 받아야 함.
    2. 감독자 10여 명으로 구성된 위원회에 제안 송부, 승인 받아야 작성자가 서브밋할 수 있음
2. 변경 생성 : 승인을 얻은 LSC 작성자는 실제 코드를 수정하기 시작
3. 시드로 나누기와 서브밋 : 글로벌 변경 생성 후 작성자는 Rosie 실행(거대한 변경을 하나 입력받아 서브밋할 수 있는 작은 변경(샤드)로 쪼개줌)
4. 마무리 청소

### 마치며

LSC는 구글 소프트웨어 엔지니어링 생태계에서 중요한 요소이다. 한 번 결정하면 되돌릴 수 없던 설계를 LSC 덕분에 필요하면 사후에 변경할 수 있게 되었다. 

크지 않더라도 코드베이스 전반을 건드리는 변경을 어떻게 진행할지 생각해보는 것이 좋다. 그러면 세월이 흘러도 소스 코드를 원하는 방향으로 유연하게 진화시켜줄 것이다.

### 핵심정리

- LSC 프로세스는 되돌릴 수 없다고 여기던 기술적 결정들을 다시 생각해볼 수 있게해줌
- 전통적인 리펙토링 모델은 코드 규모가 커지면서 한계를 드러냄
- LSC에 성공하려면 LSC를 습관처럼 진행하기
